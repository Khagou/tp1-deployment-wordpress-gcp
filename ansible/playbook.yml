# playbook.yml

- name: Install and configure WordPress on instance-1
  hosts: wordpress-instance
  gather_facts: false
  become: true
  vars:
    # Version de WordPress à installer (vous pouvez changer cela en fonction de votre préférence)
    wordpress_version: "5.8"
    # Titre du site WordPress
    wordpress_site_title: "Votre Site WordPress"
    # Nom d'utilisateur administrateur de WordPress
    wordpress_admin_user: "admin"
    # Mot de passe administrateur de WordPress
    wordpress_admin_password: "admin_password"
    # Mot de passe root de MariaDB
    mariadb_root_password: "mariadb_root_password"
    # Nom de la base de données WordPress
    wordpress_db_name: "wordpressdb"
    # Nom d'utilisateur de la base de données WordPress
    wordpress_db_user: "wordpressuser"
    # Mot de passe de la base de données WordPress
    wordpress_db_password: "wordpresspassword"

  tasks:
    # Tâches pour wordpress
    - name: Update apt cache
      apt:
        update_cache: yes
      become: true

    - name: Install required packages for WordPress
      apt:
        name: "{{ item }}"
        state: present
      become: true
      with_items:
        - apache2
        - php
        - php-mysql
        - libapache2-mod-php
        - default-mysql-client

    - name: Download and extract WordPress
      get_url:
        url: "https://wordpress.org/wordpress-{{ wordpress_version }}.tar.gz"
        dest: /tmp/wordpress.tar.gz

    - name: Extract WordPress archive
      unarchive:
        src: /tmp/wordpress.tar.gz
        dest: /var/www/html
        remote_src: yes
        creates: /var/www/html/wordpress

    - name: Set ownership and permissions for WordPress
      file:
        path: /var/www/html/wordpress
        state: directory
        owner: www-data
        group: www-data
        mode: "0755"

    - name: Copy WordPress configuration file
      template:
        src: wp_config.php
        dest: /var/www/html/wordpress/wp_config.php

  handlers:
    # Handlers pour instance-1 (WordPress)
    - name: Restart Apache
      service:
        name: apache2
        state: restarted
      become: true

- name: Install and configure MariaDB on instance-2
  hosts: mariadb-instance
  gather_facts: false
  become: true

  tasks:
    # Tâches pour instance-2 (MariaDB)
    - name: Update apt cache
      apt:
        update_cache: yes
      become: true

    - name: Install MariaDB server
      apt:
        name: mariadb-server
        state: present
      become: true

    - name: Secure MariaDB installation (optional, you can remove this task if you don't need it)
      mysql_user:
        name: root
        password: "{{ mariadb_root_password }}"
        login_unix_socket: /var/run/mysqld/mysqld.sock
        host_all: yes

    - name: Create MySQL database for WordPress
      mysql_db:
        name: "{{ wordpress_db_name }}"
        state: present
        login_user: root
        login_password: "{{ mariadb_root_password }}"

    - name: Create MySQL user for WordPress
      mysql_user:
        name: "{{ wordpress_db_user }}"
        password: "{{ wordpress_db_password }}"
        priv: "{{ wordpress_db_name }}.*:ALL"
        state: present
        login_user: root
        login_password: "{{ mariadb_root_password }}"

    - name: Flush MySQL privileges
      mysql_user:
        name: ""
        password: ""
        priv: "*.*:USAGE"
        state: present
        login_user: root
        login_password: "{{ mariadb_root_password }}"

- name: Restart Apache to apply changes
  hosts: wordpress-instance
  tasks:
    - name: Restart Apache
      service:
        name: apache2
        state: restarted
